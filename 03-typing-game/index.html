<title>Monkey Type Clone - Test your typing skills! </title>
<style>
    :root {
        color-scheme:  dark;
        --green: #00b755;
        --yellow: #daaf38;
        --red: #ca4754;
        --black: #222;
        --gray: #999;
    }
    body{
        background:  var(--black);
        font-family: 'fira code', Arial, Helvetica, sans-serif;
        display: grid;
        padding: 32px;
        justify-content: center;
        margin-top: 32px;
        padding: 16px;
    }
    main {
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 4px;
        max-width: 500px;
    }
    time {
        color: var(--yellow);
    }

    input {
        z-index: -999;
        position: absolute;
        top: 0;
        left: 0;
        pointer-events: none;
        /* opacity: 0;*/

    }

    p {
        display: flex;
        flex-wrap: wrap;
        gap: 9px 8px;
        margin: 0;
    }

    letter {
        color: var(--gray);
        position: relative;

        &.active::before {
            content: '|';
            color: #daaf38;
            font-size: 16px;
            position: absolute;
            left: -65%;
            animation: 1s blink infinite ease-in-out;
        }

        &.active.is-last::before {
            left: 65%;
        }
        &.correct {
            color: var(--green);
        }

        &.incorrect {
            color: var(--red);
        }
    }

    word {
        border-bottom: 2px solid transparent;
        transition: border-color 0.3s ease-in-out;

        &.marked {
            border-color: var(--red);
        }
    }

    @keyframes blink {ç
        0%, 50%{
        opacity: 1;
        }
        75%{
            opacity: 0;
        }
    }
</style>

<body>
    <main>
        <section id="game">
            <time></time>
            <p></p>
            <input autofocus>
        </section>
    </main>
</body>

<script>
    const $time = document.querySelector('time');
    const $paragraph = document.querySelector('p');
    const $input = document.querySelector('input')


    const INITIAL_TIME = 30;

    const TEXT = 'the quick brow fox jumps over the lazi dog and midudev is trying to clone monkey type for fun and profit using vanilla js for the yping test speed';


    let words = []
    let currentTime = INITIAL_TIME;

    initGame()
    initEvents()

    function initGame() {
        words = TEXT.split(' '.slice(0,32))
        currentTime = INITIAL_TIME

        $time.textContent = currentTime;

        $paragraph.innerHTML = words.map((word, index) => {
            const letters = word.split('')

            return `<word>
                ${letters
                .map(letter => `<letter>${letter}</letter>`)
                .join('')
            }
            </word>
            `
        }).join('')

        const $firstWord = $paragraph.querySelector('word')
        $firstWord.classList.add('active')
        $firstWord.querySelector('letter').classList.add('active')

        const intervalId = setInterval(() =>{
            currentTime--
            $time.textContent = currentTime

            if (currentTime === 0) {
                clearInterval(intervalId)
                gameOver()
            }
        },1000)
    }

    function initEvents() {
        // hacemos que al pulsar una tecla el input reciba el foco
        document.addEventListener('keydown', () => {
            $input.focus() 
        })
        $input.addEventListener('keydown', oneKeyDown)
        $input.addEventListener('keyup', oneKeyUp)
    }

    function oneKeyDown (event) {
        const $currentWord = $paragraph.querySelector('word.active')
        const $currentLetter = $currentWord.querySelector('letter.active')

        const { key } = event
        if ( key === ' ') {
            event.preventDefault() // previene que se use el espacio, como caracter
        
            //sacamos la siguiente palabra <word>
            const $nextWord = $currentWord.nextElementSibling
            const $nextLetter = $nextWord.querySelector('letter')

            // limpiamos clases
            $currentWord.classList.remove('active', 'marked')
            $currentLetter.classList.remove('active')

            // damos clases
            $nextWord.classList.add('active')
            $nextLetter.classList.add('active')
            
            // limpiamos el input con un vacio
            $input.value = ''
            
            // comprobamos si has completado la palabra
            const hasMissedLetters = $currentWord
                .querySelectorAll('letter:not(.correct)').length > 0
            
            const classToAdd = hasMissedLetters ? 'marked' : 'correct'
            $currentWord.classList.add(classToAdd)
        
        }
    }

    function oneKeyUp () {
        // recuperamos los elementos actuales
        const $currentWord = $paragraph.querySelector('word.active') //recuperamos la palabra 
        const $currentLetter = $currentWord.querySelector('letter.active') // recuperamos la letra

        const currentWord = $currentWord.innerText.trim()
        $input.maxLength = currentWord.length // limiotamos el numero de letras
        console.log({value: $input.value, currentWord })

        const $allLetters = $currentWord.querySelectorAll('letter')
        
        // borramos las clases correct and incorrect
        $allLetters.forEach($letter => $letter.classList.remove('correct','incorrect'))

        $input.value.split('').forEach((char, index) => {
            const $letter = $allLetters[index]
            const letterToCheck = currentWord[index]

            const isCorrect = char === letterToCheck //comprobamos
            const letterClass = isCorrect ? 'correct' : 'incorrect' //asignamos clase
            //añadimos al elemento la clase
            $letter.classList.add(letterClass)

        })
        //borramos el active que es la barrita
        $currentLetter.classList.remove('active', 'is-last')
        const inputLength = $input.value.length //buscamos la longitud del imput
        const $nextActiveLetter = $allLetters[inputLength]

        if ($nextActiveLetter) {
            $allLetters[inputLength].classList.add('active') //añadimos el active
        } else {
            $currentLetter.classList.add('active','is-last')
        }
    }

    function gameOver(){
        console.log('Game over')
    }


</script>