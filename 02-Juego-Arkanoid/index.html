<title>Arkanoid en JavaScript</title>
<style>
    body{
        background-color:  #111;
    }

    canvas {
        border: 4px solid #fff;
        border-bottom: transparent;
        background: url('./bkg.png') repeat;
        margin: 0 auto;
        display: block;
    }
</style>
<canvas></canvas>

<img hidden id="sprite" src="./sprite.png" alt="Srpite Arkanoid" />
<img hidden id="bricks" src="./bricks.png" alt="Bricks Arkanoid" />
<script>
    const canvas = document.querySelector('canvas');
    const ctx = canvas.getContext('2d') // 2D rendering context

    const $sprite = document.querySelector('#sprite')
    const $bricks = document.querySelector('#bricks')
    canvas.width = 448
    canvas.height = 400


    /* variables de nuestro juego */
   // let counter = 0

    /* VARIABLES DE LA PELOTA  */
    const ballRadius = 3;
    // posicion de la pelota
    let x = canvas.width / 2
    let y = canvas.height - 30
    /* velocidad de la pelota */
    
    let dx = 3
    let dy = -3

    /* VARIABLES DE LA PALETA */
    const paddleHeight = 10;
    const paddleWidth = 50;

    let paddleX = (canvas.width - paddleWidth) / 2
    let paddleY = canvas.height - paddleHeight - 10

    let rightPressed = false
    let leftPressed = false

    /* VARIABLES DE LOS LADRILLOS */
    const brickRowCount = 6;
    const brickColumCount = 13;
    const brickWidth = 32;
    const brickHeight = 16;
    const brickPadding = 0;
    const brickOffsetTop = 80;
    const brickOffsetLeft = 16;
    const bricks = [];

    const BRICK_STATUS = {
        ACTIVE: 1,
        DESTROYED: 0  
    }

    for(let c = 0; c < brickColumCount; c++){
        bricks[c] = [] // inicializamos con un array vacio
        for (let r = 0; r < brickRowCount; r++){
            // calculamos la posicion del ladrillo en la pantalla
            const brickX = c * (brickWidth + brickPadding) + brickOffsetLeft
            const brickY = r * (brickHeight + brickPadding) + brickOffsetTop
            // asignar un color aleatorio a cada ladrillo
            const random = Math.floor(Math.random()*8) 
            //(saca numeros del 0 al 7, del 1 al 8 añadir +1 )truquillo importante para tener en la memoria para sacar numeros enteros
            //guardamos la informacion de cada ladrillo
            bricks[c][r] = {
                x: brickX, 
                y: brickY, 
                status: BRICK_STATUS.ACTIVE, 
                color: random}
        }
    }

    const PADDLE_SENSITIVITY = 7
    /* funciones basicas del juego */
    function drawBall() {
        ctx.beginPath() // iniciar el trazado
        ctx.arc(x, y, ballRadius, 0, Math.PI * 2)
        ctx.fillStyle = '#fff'
        ctx.fill()
        ctx.closePath() // cierras el trazado
    }
    function drawPaddle() {
        /*
        ctx.fillStyle = 'red'
        ctx.fillRect( // le damos los datos del tamaño y posicion paleta
            paddleX, // coordenada X
            paddleY, // cordenada Y   
            paddleWidth, // ancho del dibujo
            paddleHeight // alto del dibujo
        )
        */
        ctx.drawImage(
            $sprite, // la imagen
            29,// el clipX: coordenadas de recorte
            174,// clipY:  coordenadas de recorte
            paddleWidth, // el tamaño del recorte
            paddleHeight, // el tamaño del recorte
            paddleX, // posicion X del dibujo
            paddleY, // posicion Y del dibujo
            paddleWidth, // Ancho del dibujo
            paddleHeight // Alto del dibujo
        )
    }
    function drawBricks () {
        for(let c = 0; c < brickColumCount; c++){
          for (let r = 0; r < brickRowCount; r++){
            const currentBrick = bricks[c][r]
            if(currentBrick.status === BRICK_STATUS.DESTROYED)
                continue; //si esta destruido no pinta ladrillo
                
                /*
                ctx.fillStyle = 'yellow'
                ctx.rect(
                    currentBrick.x,
                    currentBrick.y,
                    brickWidth,
                    brickHeight
                )
                ctx.strokeStyle = '#000'
                ctx.stroke()
                ctx.fill()
                */
                const clipX = currentBrick.color * 32
                ctx.drawImage(
                    $bricks,
                    clipX,
                    0,
                    brickWidth,
                    brickHeight,
                    currentBrick.x,
                    currentBrick.y,
                    brickWidth,
                    brickHeight
                )
            }
        }
    }

    function collisionDetection () {
        for(let c = 0; c < brickColumCount; c++){
            for (let r = 0; r < brickRowCount; r++){
            const currentBrick = bricks[c][r]
            if (currentBrick.status === BRICK_STATUS.DESTROYED) continue;
                
            const isBallSameXAsBrick =
              x > currentBrick.x &&
              x < currentBrick.x + brickWidth
            const isBallSameYAsBrick =
              y > currentBrick.y &&
              y < currentBrick.y + brickHeight
            
            if ( isBallSameXAsBrick && isBallSameYAsBrick){
                dy = -dy
                currentBrick.status = BRICK_STATUS.DESTROYED
            }
            }
        }
    }

    function ballMovement () {
        //rebotar las pelotas en los laterales
        if (
            x + dx > canvas.width - ballRadius || //pared derecha
            x + dx < ballRadius  // pared izquierda
        ){
            dx = -dx //se cambia la orientación
        }

        //rebotar en la parte de arriba
        if( y + dy < ballRadius){
            dy = -dy 
        }
        // la pelota toca la pala
        const isBallSameXAsPaddle = 
         x > paddleX &&
         x < paddleX + paddleWidth

        const isBallTouchingPaddle = 
         y + dy > paddleY

        if (isBallSameXAsPaddle && isBallTouchingPaddle){ 
            dy = -dy // cambiamos la direccion de la pelota
        // la pelota toca el suelo
        }else if (
            y + dy > canvas.height - ballRadius - 7
            ){
            console.log('Game Over')
            document.location.reload();
        }

        // mover la pelota
        x += dx
        y += dy
    }
    function paddleMovement () {
        if(rightPressed && paddleX < canvas.width - paddleWidth){
            paddleX += PADDLE_SENSITIVITY
        } else if ( leftPressed && paddleX > 0) {
            paddleX -= PADDLE_SENSITIVITY
        }
    }


    function cleanCanvas () {
        // borramos todo lo pintado en pantalla
        ctx.clearRect(0, 0, canvas.width, canvas.height)
    }

    function initEvents () {
        document.addEventListener('keydown', keyDownHandler)
        document.addEventListener('keyup', keyUpHandler)

        function keyDownHandler (event) {
            const { key } = event
            if(key === 'Right' || key === 'ArrowRight'){
                rightPressed = true
            } else if (key === 'Left' || key === 'ArrowLeft') {
                leftPressed = true
            }
        }

        function keyUpHandler (event) {
            const { key } = event
            if(key === 'Right' || key === 'ArrowRight'){
                rightPressed = false
            } else if (key === 'Left' || key === 'ArrowLeft') {
                leftPressed = false
            }
        }
    }



    /*
     la base de cualquier videojuego es crear una funcion
     y usar window.requestAnimationFrame(nombreFuncion) para llamarla en "bucle"
     y asi estar actualizando a la tasa de refresco de la pantalla
    */
    function draw () {
        cleanCanvas() //borramos la pantalla para volver a pintar
        // aqui harás tus dibujos y checks de colisiones (y ya estaria el juego)  
        
        drawBall()
        drawPaddle()
        drawBricks()
        // drawScore()

        // colisiones y movimientos
        collisionDetection()
        ballMovement()
        paddleMovement()
        
        window.requestAnimationFrame(draw) //llama a la funcion draw para estar actualizando en "bucle"
    }

    // llamamos a la funcion
    draw();
    initEvents();


</script>